<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extending srvyr • srvyr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extending srvyr">
<meta property="og:description" content="srvyr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
<img src="../tools/logo.png" height="50" width="50" align="left" display="block" style="margin: -15px 10px 0px 0px">
        <a class="navbar-link" href="../index.html">srvyr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.10</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/srvyr-vs-survey.html">Overview</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/srvyr-vs-survey.html">srvyr Compared to the survey Package (Overview)</a>
    </li>
    <li>
      <a href="../articles/srvyr-database.html">Databases in srvyr</a>
    </li>
    <li>
      <a href="../articles/extending-srvyr.html">Extending srvyr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/gergness/srvyr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="extending-srvyr_files/header-attrs-2.2.2/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extending srvyr</h1>
                        <h4 class="author">Greg Freedman Ellis</h4>
            
            <h4 class="date">2020-06-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/gergness/srvyr/blob/master/vignettes/extending-srvyr.Rmd"><code>vignettes/extending-srvyr.Rmd</code></a></small>
      <div class="hidden name"><code>extending-srvyr.Rmd</code></div>

    </div>

    
    
<pre><code>## Loading required package: convey</code></pre>
<pre><code>## Warning in library(package, lib.loc = lib.loc, character.only = TRUE,
## logical.return = TRUE, : there is no package called 'convey'</code></pre>
<pre><code>## Loading required package: laeken</code></pre>
<pre><code>## Missing convey and laeken packages. Install them to run vignette.</code></pre>
<p>I don’t expect this vignette to be help for most srvyr users, it is instead intended for other package developers. An exciting new feature that is easier now that I have reworked srvyr’s non-standard evaluation to match dplyr 0.7+ is that it is now possible for non-srvyr functions to be called from within <code>summarize</code>. This vignette describes some of the inner-workings of summarize so that others can extend srvyr. This is kind of a fiddly part of srvyr, and I don’t expect that many people will want or need to understand it, so this guide is mostly aimed at package authors who already have an understanding of how survey objects work. If you’d like more explanation, please let me know on <a href="https://github.com/gergness/srvyr">github</a>!</p>
<div id="translating-from-survey-to-srvyr" class="section level2">
<h2 class="hasAnchor">
<a href="#translating-from-survey-to-srvyr" class="anchor"></a>Translating from survey to srvyr</h2>
<p>srvyr implements the “survey statistics” functions from the survey package. Some examples are the svymean, svytotal, svyciprop, svyquantile and svyratio all return a <code>svystat</code> object which usually prints out the estimate and its standard error and other estimates of the variance can be calculated from it. In srvyr, these estimates are created inside of a summarize call and the variance estimates are specified at the same time.</p>
<p>The combination of srvyr’s group_by and summarize is analogous to the <code>svyby</code> function that performs one of the survey statistic function and performs it on multiple groups.</p>
<p>Note that srvyr does not implement many other types of calculations that the survey package can (notably the regressions). While some of these could be shoehorned into srvyr, I feel that they are outside the scope of what people usually expect to have in a data.frame. In general, I think the broom package is better for tidying these kinds of calculations.</p>
</div>
<div id="what-summarize-expects" class="section level2">
<h2 class="hasAnchor">
<a href="#what-summarize-expects" class="anchor"></a>What summarize expects</h2>
<p>srvyr’s summarize expects that the survey statistics functions will return objects that are formatted in a particular way. Below, I’ll explain some of the functions that will help create these objects for you in most cases, but the return should be:</p>
<ul>
<li>A <code>data.frame</code> object</li>
<li>If ungrouped, 1 row long, otherwise 1 row per group</li>
<li>If grouped, include both the grouping variables and the estimates</li>
<li>The names are based on the argument name from the summarize call but this name can’t provided to the functions. Instead, summarize does the renaming and your function should name the variables “__SRVYR_COEF__” (which is renamed to the parameter name) or with a suffix that will be appended after the parameter name.</li>
</ul>
</div>
<div id="helper-functions-exported-by-srvyr" class="section level2">
<h2 class="hasAnchor">
<a href="#helper-functions-exported-by-srvyr" class="anchor"></a>Helper functions exported by srvyr</h2>
<p>srvyr now exports several functions that can help convert functions designed for the survey package to this format.</p>
<ul>
<li>
<code><a href="../reference/current_svy.html">current_svy()</a></code> - This function, modeled after <code><a href="https://dplyr.tidyverse.org/reference/select_vars.html">dplyr::current_vars()</a></code>, is a hidden way to send the survey object to the object (by hidden, I mean that the user doesn’t have to specify the survey in the arguments of their function call). To use it, have an argument in your functions that defaults to current_svy().</li>
<li>
<code><a href="../reference/set_survey_vars.html">set_survey_vars()</a></code> - Many survey functions have limited support for both supplying a formula indicating the variables to calculate a statistic on as well as a vector. However, oftentimes the vector version is less well supported than the formula version. Since srvyr uses dplyr semantics, it ends up returning the values as vectors. This function will add on the variable to the survey, defaulting to having the name “__SRVYR_TEMP_VAR__”.</li>
<li>
<code><a href="../reference/get_var_est.html">get_var_est()</a></code> - A helper function that calculates variance estimates like standard error (se), confidence interval (ci), variance (var), or coefficient of variance (cv). For functions that support it, there is a separate argument for design effects (to match survey’s conventions).</li>
</ul>
<p>Note that these functions may not work in all cases. In srvyr, I’ve actually had to write 3 versions of <code><a href="../reference/get_var_est.html">get_var_est()</a></code> because of minor differences in the way survey objects are returned. Hopefully they will help in most situations, or at least give you a good place to start.</p>
</div>
<div id="miscellaneous-conventions" class="section level2">
<h2 class="hasAnchor">
<a href="#miscellaneous-conventions" class="anchor"></a>Miscellaneous conventions</h2>
<p>Two less important conventions that srvyr functions follow are:</p>
<ol style="list-style-type: decimal">
<li>snake_case function names (to better match the tidyverse)</li>
<li>Multiple choice arguments that default to the first (so for var_type, if no parameters are specified, use only “se” not all of them).</li>
</ol>
</div>
<div id="example-conveysvygini---survey_gini" class="section level2">
<h2 class="hasAnchor">
<a href="#example-conveysvygini---survey_gini" class="anchor"></a>Example: convey::svygini -&gt; survey_gini</h2>
<p>That was just a lot of text, but I think it’s probably easiest just to provide an example. The convey package provides several methods for analysis of inequality using survey data. The svygini function calculates the gini coefficient. Here, we’ll write functions that make a srvyr version <code>survey_gini</code>.</p>
<p>To distinguish between ungrouped and grouped survey objects, we’ll make a generic. Also note the use of <code>.svy = current_svy()</code> to get the survey object from the current summarize context.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># S3 generic function</span>
<span class="no">survey_gini</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(
  <span class="no">x</span>, <span class="no">na.rm</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="no">vartype</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"se"</span>, <span class="st">"ci"</span>, <span class="st">"var"</span>, <span class="st">"cv"</span>), <span class="no">.svy</span> <span class="kw">=</span> <span class="fu"><a href="../reference/current_svy.html">current_svy</a></span>(), <span class="no">...</span>
) {
  <span class="fu"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span>(<span class="st">"survey_gini"</span>, <span class="no">.svy</span>)
}</pre></body></html></div>
<p>And here’s the ungrouped version, which uses <code><a href="../reference/set_survey_vars.html">set_survey_vars()</a></code>, <code>convey::svygini()</code> and <code><a href="../reference/get_var_est.html">get_var_est()</a></code>.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">survey_gini.tbl_svy</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(
  <span class="no">x</span>, <span class="no">na.rm</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="no">vartype</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"se"</span>, <span class="st">"ci"</span>, <span class="st">"var"</span>, <span class="st">"cv"</span>), <span class="no">.svy</span> <span class="kw">=</span> <span class="fu"><a href="../reference/current_svy.html">current_svy</a></span>(), <span class="no">...</span>
) {
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span>(<span class="no">vartype</span>)) <span class="no">vartype</span> <span class="kw">&lt;-</span> <span class="st">"se"</span>
  <span class="no">vartype</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html">match.arg</a></span>(<span class="no">vartype</span>, <span class="kw">several.ok</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  <span class="no">.svy</span> <span class="kw">&lt;-</span> <span class="kw pkg">srvyr</span><span class="kw ns">::</span><span class="fu"><a href="../reference/set_survey_vars.html">set_survey_vars</a></span>(<span class="no">.svy</span>, <span class="no">x</span>)

  <span class="no">out</span> <span class="kw">&lt;-</span> <span class="kw pkg">convey</span><span class="kw ns">::</span><span class="fu">svygini</span>(~<span class="no">`__SRVYR_TEMP_VAR__`</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">na.rm</span>, <span class="kw">design</span> <span class="kw">=</span> <span class="no">.svy</span>)
  <span class="no">out</span> <span class="kw">&lt;-</span> <span class="kw pkg">srvyr</span><span class="kw ns">::</span><span class="fu"><a href="../reference/get_var_est.html">get_var_est</a></span>(<span class="no">out</span>, <span class="no">vartype</span>)
  <span class="no">out</span>
}</pre></body></html></div>
<p>Finally, the grouped version which uses the above functions plus <code><a href="https://rdrr.io/pkg/survey/man/svyby.html">survey::svyby()</a></code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">survey_gini.grouped_svy</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(
  <span class="no">x</span>, <span class="no">na.rm</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="no">vartype</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"se"</span>, <span class="st">"ci"</span>, <span class="st">"var"</span>, <span class="st">"cv"</span>), <span class="no">.svy</span> <span class="kw">=</span> <span class="fu"><a href="../reference/current_svy.html">current_svy</a></span>(), <span class="no">...</span>
) {
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span>(<span class="no">vartype</span>)) <span class="no">vartype</span> <span class="kw">&lt;-</span> <span class="st">"se"</span>
  <span class="no">vartype</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html">match.arg</a></span>(<span class="no">vartype</span>, <span class="kw">several.ok</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  <span class="no">.svy</span> <span class="kw">&lt;-</span> <span class="kw pkg">srvyr</span><span class="kw ns">::</span><span class="fu"><a href="../reference/set_survey_vars.html">set_survey_vars</a></span>(<span class="no">.svy</span>, <span class="no">x</span>)
  <span class="no">grps_formula</span> <span class="kw">&lt;-</span> <span class="kw pkg">survey</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html">make.formula</a></span>(<span class="fu"><a href="../reference/groups.html">group_vars</a></span>(<span class="no">.svy</span>))

  <span class="no">out</span> <span class="kw">&lt;-</span> <span class="kw pkg">survey</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyby.html">svyby</a></span>(
    ~<span class="no">`__SRVYR_TEMP_VAR__`</span>, <span class="no">grps_formula</span>, <span class="kw pkg">convey</span><span class="kw ns">::</span><span class="no">svygini</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">na.rm</span>, <span class="kw">design</span> <span class="kw">=</span> <span class="no">.svy</span>
  )
  <span class="no">out</span> <span class="kw">&lt;-</span> <span class="kw pkg">srvyr</span><span class="kw ns">::</span><span class="fu"><a href="../reference/get_var_est.html">get_var_est</a></span>(<span class="no">out</span>, <span class="no">vartype</span>, <span class="kw">grps</span> <span class="kw">=</span> <span class="fu"><a href="../reference/groups.html">group_vars</a></span>(<span class="no">.svy</span>))
  <span class="no">out</span>
}</pre></body></html></div>
<p>And here’s what these functions look like in practice:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># Example from ?convey::svygini</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>({
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">srvyr</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">survey</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">convey</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">laeken</span>)
})
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">eusilc</span>) ; <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>( <span class="no">eusilc</span> ) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>( <span class="no">eusilc</span> ) )

<span class="co"># Setup for survey package</span>
<span class="no">des_eusilc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html">svydesign</a></span>(
  <span class="kw">ids</span> <span class="kw">=</span> ~<span class="no">rb030</span>,
  <span class="kw">strata</span> <span class="kw">=</span> ~<span class="no">db040</span>,
  <span class="kw">weights</span> <span class="kw">=</span> ~<span class="no">rb050</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">eusilc</span>
)
<span class="no">des_eusilc</span> <span class="kw">&lt;-</span> <span class="fu">convey_prep</span>(<span class="no">des_eusilc</span>)

<span class="co"># Setup for srvyr package</span>
<span class="no">srvyr_eusilc</span> <span class="kw">&lt;-</span> <span class="no">eusilc</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as_survey.html">as_survey</a></span>(
    <span class="kw">ids</span> <span class="kw">=</span> <span class="no">rb030</span>,
    <span class="kw">strata</span> <span class="kw">=</span> <span class="no">db040</span>,
    <span class="kw">weights</span> <span class="kw">=</span> <span class="no">rb050</span>
  ) <span class="kw">%&gt;%</span>
  <span class="fu">convey_prep</span>()

<span class="co">## Ungrouped</span>
<span class="co"># Calculate ungrouped for survey package</span>
<span class="fu">svygini</span>(~<span class="no">eqincome</span>, <span class="kw">design</span> <span class="kw">=</span> <span class="no">des_eusilc</span>)

<span class="co"># With our new function</span>
<span class="fu">survey_gini</span>(<span class="no">srvyr_eusilc</span>$<span class="no">variables</span>$<span class="no">eqincome</span>, <span class="kw">.svy</span> <span class="kw">=</span> <span class="no">srvyr_eusilc</span>)

<span class="co"># And finally, the more typical way through summarize</span>
<span class="no">srvyr_eusilc</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/summarise.html">summarize</a></span>(<span class="kw">eqincome</span> <span class="kw">=</span> <span class="fu">survey_gini</span>(<span class="no">eqincome</span>))

<span class="co">## Groups</span>
<span class="co"># Calculate by groups for survey</span>
<span class="kw pkg">survey</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyby.html">svyby</a></span>(~<span class="no">eqincome</span>, ~<span class="no">rb090</span>, <span class="no">des_eusilc</span>, <span class="kw pkg">convey</span><span class="kw ns">::</span><span class="no">svygini</span>)

<span class="co"># With our new function</span>
<span class="fu">survey_gini</span>(<span class="no">srvyr_eusilc</span>$<span class="no">variables</span>$<span class="no">eqincome</span>, <span class="kw">.svy</span> <span class="kw">=</span> <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="no">srvyr_eusilc</span>, <span class="no">rb090</span>))

<span class="co"># And finally, the more typical way through summarize</span>
<span class="no">srvyr_eusilc</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="no">rb090</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/summarise.html">summarize</a></span>(<span class="kw">eqincome</span> <span class="kw">=</span> <span class="fu">survey_gini</span>(<span class="no">eqincome</span>))</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Greg Freedman Ellis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
